name:  ğŸ“¦ Package Release

on:
  push:
    tags:
      - 'v*'          # æ‰“æ ‡ç­¾è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘é€‰é¡¹
    inputs:
      changelog:
        description: |
          å˜æ›´æ—¥å¿—å†…å®¹æˆ–æ–‡ä»¶è·¯å¾„ï¼š
          - ç›´æ¥è¾“å…¥å†…å®¹ï¼ˆç”¨ \n æ¢è¡Œï¼‰
          - æˆ–è¾“å…¥æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚ CHANGELOG.mdï¼‰
        required: true
        default: 'CHANGELOG.md'

permissions:
  contents: write

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # è·å–è¶³å¤Ÿçš„å†å²è®°å½•ä»¥åŒ…å«æ ‡ç­¾
          fetch-depth: 0

      - name: Prepare shared files
        run: |
          mkdir -p shared_files
          cp README.md README_en.md img.png shared_files/

      - name: Prepare release body
        run: |
          # åˆ›å»ºåŸºç¡€æ¨¡æ¿
          cat << 'EOF' > base_body.md
          # å¤šæ¨¡å—ç‹¬ç«‹å‘å¸ƒåŒ…

          ## æ¨¡å—ä»‹ç»
          -   **MADDPG_Continous**  
            å¤šæ™ºèƒ½ä½“æ·±åº¦ç¡®å®šæ€§ç­–ç•¥æ¢¯åº¦ç®—æ³•ï¼ˆè¿ç»­åŠ¨ä½œç©ºé—´ç‰ˆæœ¬ï¼‰ï¼Œé€‚ç”¨äºè¿ç»­æ§åˆ¶åœºæ™¯çš„å¤šæ™ºèƒ½ä½“ååŒè®­ç»ƒã€‚

          -    âš¡ï¸ **MATD3_Continous**  
            å¤šæ™ºèƒ½ä½“åŒå»¶è¿Ÿæ·±åº¦ç¡®å®šæ€§ç­–ç•¥æ¢¯åº¦ç®—æ³•ï¼Œåœ¨MADDPGåŸºç¡€ä¸Šå¢åŠ äº†å»¶è¿Ÿæ›´æ–°å’Œç­–ç•¥å¹³æ»‘æœºåˆ¶ã€‚

          - ğŸ“š **RL_Learning-main**  
            èµµä¸–é’°è€å¸ˆå¼ºåŒ–å­¦ä¹ åŸºç¡€æ•™ç¨‹åˆé›†ï¼ŒåŒ…å«ç»å…¸ç®—æ³•å®ç°å’Œç¤ºä¾‹ä»£ç ã€‚

          -  **hands_on_RL**  
            åŠ¨æ‰‹å­¦å¼ºåŒ–å­¦ä¹ å®è·µé¡¹ç›®ï¼Œé€šè¿‡Jupyter Notebookæä¾›äº’åŠ¨å¼å­¦ä¹ ä½“éªŒã€‚

          ## ä½¿ç”¨è¯´æ˜
          1. ç‚¹å‡»ä¸‹æ–¹æ‰€éœ€æ¨¡å—çš„ZIPæ–‡ä»¶ä¸‹è½½
          2. è§£å‹åé˜…è¯»README.mdè·å–è¯¦ç»†ä½¿ç”¨æŒ‡å—
          3. å®‰è£…ä¾èµ–ï¼š`pip install -r requirements.txt`

          ## æ”¯æŒæ¸ é“
          - [ä¸­æ–‡é—®é¢˜æäº¤](https://github.com/Ronchy2000/Multi-agent-RL/issues/new?labels=zh)
          - è®¸å¯è¯ï¼š[MIT](LICENSE)

          ---

          # Independent Modules Release

          ## Available Modules
          -  **MADDPG_Continous**  
            Multi-Agent Deep Deterministic Policy Gradient (continuous action space version) for cooperative multi-agent control.

          - ï¸ **MATD3_Continous**  
            Multi-Agent Twin Delayed DDPG, featuring delayed updates and policy smoothing.

          -  ğŸ“š **RL_Learning-main**  
            Fundamental RL tutorials with classic algorithm implementations.

          -    ğŸ§  **hands_on_RL**  
            Interactive reinforcement learning projects via Jupyter Notebooks.

          ## Quick Start
          1. Download the desired module ZIP below
          2. Check README_en.md for detailed instructions
          3. Install dependencies: `pip install -r requirements.txt`

          ## Support
          - [English Issues](https://github.com/Ronchy2000/Multi-agent-RL/issues/new?labels=en)
          - License: [MIT](LICENSE)
          EOF
          
          # è·å–å˜æ›´æ—¥å¿—è¾“å…¥
          INPUT_CHANGELOG="${{ github.event.inputs.changelog }}"
          
          # æ£€æµ‹è¾“å…¥æ˜¯å¦æ˜¯æ–‡ä»¶è·¯å¾„
          if [ -f "$INPUT_CHANGELOG" ]; then
            echo "ä»æ–‡ä»¶è¯»å–å˜æ›´æ—¥å¿—: $INPUT_CHANGELOG"
            CHANGELOG_CONTENT=$(cat "$INPUT_CHANGELOG")
          else
            echo "å¤„ç†æ‰‹åŠ¨è¾“å…¥çš„å˜æ›´æ—¥å¿—"
            # å°† \n æ›¿æ¢ä¸ºå®é™…æ¢è¡Œç¬¦
            CHANGELOG_CONTENT=$(echo -e "$INPUT_CHANGELOG" | sed 's/\\n/\n/g')
          fi
          
          # æ·»åŠ ç‰ˆæœ¬å·æ ‡é¢˜
          VERSION="${{ github.ref_name }}"
          CHANGELOG_CONTENT="# ç‰ˆæœ¬ $VERSION\n\n$CHANGELOG_CONTENT"

          # åˆ›å»ºå®Œæ•´çš„å‘å¸ƒè¯´æ˜
          echo -e "# å˜æ›´æ—¥å¿— / Changelog\n\n$CHANGELOG_CONTENT\n\n---\n\n" > full_body.md
          cat base_body.md >> full_body.md
          
          # æ‰“å°ç”Ÿæˆçš„å†…å®¹ç”¨äºè°ƒè¯•
          echo "===== ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜é¢„è§ˆï¼ˆå‰10è¡Œï¼‰ ====="
          head -n 10 full_body.md
          echo "..."
          echo "====================================="

      - name: Package each folder
        run: |
          mkdir -p zips
          # éœ€è¦æ‰“åŒ…çš„æ–‡ä»¶å¤¹åˆ—è¡¨
          TARGET_FOLDERS=(
            "MADDPG_Continous"
            "MATD3_Continous"
            "RL_Learning-main"
            "åŠ¨æ‰‹å­¦å¼ºåŒ–å­¦ä¹ "   # ä¿ç•™åŸå§‹ä¸­æ–‡åç§°
          )

          for folder in "${TARGET_FOLDERS[@]}"; do
            if [ -d "$folder" ]; then
              # ä¸ºä¸­æ–‡æ–‡ä»¶å¤¹è®¾ç½®è‹±æ–‡è¾“å‡ºåç§°
              if [ "$folder" = "åŠ¨æ‰‹å­¦å¼ºåŒ–å­¦ä¹ " ]; then
                output_name="hands_on_RL"
              else
                output_name="$folder"
              fi
              
              # åˆ›å»ºä¸´æ—¶ç›®å½•
              mkdir -p "temp_$output_name"
              
              # å¤åˆ¶æ–‡ä»¶å¤¹å†…å®¹ï¼ˆä¿ç•™åŸå§‹ç»“æ„ï¼‰
              cp -r "$folder" "temp_$output_name/"
              
              # æ·»åŠ å…±äº«æ–‡ä»¶
              cp shared_files/* "temp_$output_name/"
              
              # æ‰“åŒ…ä¸ºè‹±æ–‡åç§°çš„ZIP
              (cd "temp_$output_name" && zip -r "../zips/$output_name.zip" .)
              echo "âœ… Packaged: $folder as $output_name.zip"
            else
              echo "âš ï¸ Folder not found: $folder"
            fi
          done

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          body_path: full_body.md
          files: |
            zips/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}